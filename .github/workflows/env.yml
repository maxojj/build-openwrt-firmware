name: SSH Access to Ubuntu Environment

on: push

jobs:
  setup-ssh:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Install and configure SSH server
      run: |
        sudo apt-get update
        sudo apt-get install -y openssh-server
        sudo systemctl start ssh
        sudo systemctl enable ssh

        # Create a user for SSH access
        sudo useradd -m github_runner
        sudo mkdir -p /home/github_runner/.ssh
        echo "${{ secrets.SSH_PUBLIC_KEY }}" | sudo tee /home/github_runner/.ssh/authorized_keys
        sudo chown -R github_runner:github_runner /home/github_runner/.ssh
        sudo chmod 700 /home/github_runner/.ssh
        sudo chmod 600 /home/github_runner/.ssh/authorized_keys

        # Configure SSHD
        echo "AllowUsers github_runner" | sudo tee -a /etc/ssh/sshd_config
        sudo systemctl restart ssh

        # Print SSH access details
        echo "SSH into the runner using the following command:"
        echo "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no github_runner@$(curl -s http://checkip.amazonaws.com)"

    - name: Wait for SSH connection
      run: sleep 3600  # This will keep the runner alive for 1 hour to allow SSH connections
